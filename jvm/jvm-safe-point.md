# JVM 安全点

`安全点` 可以理解成是让线程（用户线程）停下来的一种实现方式。

## 安全点 safepoint

JVM在暂停的时候，需要选准一个时机，由于JVM系统运行期间的复杂性，不可能做到随时暂停，因此引入了安全点(safepoint) 概念:程序只有在运行到安全点的时候，才准暂停下来。HotSpot采用`主动中断`的方式，让执行线程在运行时轮询是否需要暂停的标识，若需要暂停则中断挂起。HotSpot使用了几条短小精炼的汇编指令便可完成安全点轮询以及触发线程中断，因此对系统性能的影响可以忽略不计。

- SafepointSynchronize::begin 进入安全点
- SafepointSynchronize::end 退出安全点

进入安全点时Java线程可能存在几种不同的状态：

(1)处于解释执行字节码的状态，解释器在通过字节码派发表(Dispach Tabl)获取下一条字节码的时候，会主动检查安全带的状态。

(2)处于执行native代码的状态，也就是执行JNI。此时VMThed不会等待线租进入安全点。执行JNI退出后线程需要主动检查安全点状态，如果此时安全点位置被标记行，那么就不能继续执行，需要等待安全点位置被清除后才能继续执行。

(3)处于编译代码执行状态，编译器会在合适的位置(例如循环、方法调用等)插入读取全局Safepoint Polling内存页的指令，如果此时安全点位置被标记了，那么Safepoint Plling内存页会变成不可读，此时线程会因为读取了不可读的内存页而陷入内核态，事先注册好的信号处理程序就会处理这个信号并让线程进入安全点。

(4)线程本身处于blocked状态，例如线程在等待锁，那么线程的阻塞状态将不会结束直到安全点标志被清除。

(5)当线程处于以上(1)至(3) 3种状态切换阶段，切换前会先检查安全点的状态，如果此时要求进入安全点，那么切换将不被允许，需要等待，直到安全点状态被清除。
