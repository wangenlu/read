# 广播和多播

- 单播地址
- 广播地址
- 多播地址
- 受限的广播 255.255.255.255
- 指向网络的广播
- 指向子网的广播
- 指向所有子网的广播

广播和多播仅应用于 UDP，它们对需将报文同时传往多个接收者的应用来说十分重要。
TCP 是一个面向连接的协议，它意味着分别运行于两主机（由 IP 地址确定）内的两进程（由
端口号确定）间存在一条连接。

然而，有时一个主机要向网上的所有其他主机发送帧，这就是广播。通过 ARP 和 RARP 可以看到这一过程。多播
(multicast)处于单播和广播之间：帧仅传送给属于多播组的多个主机。

大多数的网卡经过配置都能接收目的地址为多播地址或某些子网多播地址的帧。对于以太网，当地址中
最高字节的最低位设置为 1 时表示该地址是一个多播地址，用十六进制可表示为 01:00:00:00:00:00（以太网广播地址
ff:ff:ff:ff:ff:ff 可看作是以太网多播地址的特例）。

如果网卡收到一个帧，这个帧将被传送给设备驱动程序（如果帧检验和错，网卡将丢弃
该帧）。设备驱动程序将进行另外的帧过滤。首先，帧类型中必须指定要使用的协议（IP、
ARP 等等）。其次，进行多播过滤来检测该主机是否属于多播地址说明的多播组。
设备驱动程序随后将数据帧传送给下一层，比如，当帧类型指定为 IP 数据报时，就传往
IP 层。IP 根据 IP 地址中的源地址和目的地址进行更多的过滤检测。如果正常，就将数据报传送
给下一层（如 TCP 或 UDP）。

每次 UDP 收到由 IP 传送来的数据报，就根据目的端口号，有时还有源端口号进行数据报过滤。
如果当前没有进程使用该目的端口号，就丢弃该数据报并产生一个 ICMP 不可达报文
（TCP 根据它的端口号作相似的过滤）。如果 UDP 数据报存在检验和错，将被丢弃。
使用广播的问题在于它增加了对广播数据不感兴趣主机的处理负荷。拿一个使用 UDP 广
播应用作为例子。如果网内有 50 个主机，但仅有 20 个参与该应用，每次这 20 个主机中的一个
发送 UDP 广播数据时，其余 30 个主机不得不处理这些广播数据报。一直到 UDP 层，收到的
UDP 广播数据报才会被丢弃。这 30 个主机丢弃 UDP 广播数据报是因为这些主机没有使用这个目的端口。

多播的出现减少了对应用不感兴趣主机的处理负荷。使用多播，主机可加入一个或多个
多播组。这样，网卡将获悉该主机属于哪个多播组，然后仅接收主机所在多播组的那些多播帧。

> 图 12-1 协议栈各层对收到帧的过滤过程

[TCP-IP-12-1.svg](./images/TCP-IP-12-1.svg)

> 广播的流程

首先，网卡查看由信道传送过来的帧，确定是否接收该帧，若接收后就将它传往设备驱动程序。通常网卡仅接
收那些目的地址为网卡物理地址或广播地址的帧。另外，多数接口均被设置为混合模式，这种模式能接收每个帧的
一个复制。作为一个例子， `tcpdump` 使用这种模式。

目前，大多数的网卡经过配置都能接收目的地址为`多播地址`或某些`子网多播地址`的帧。
对于以太网，当地址中`最高字节`的`最低位`设置为`1`时表示该地址是一个多播地址，
用十六进制可表示为 `01:00:00:00:00:00`（以太网广播地址 `ff:ff:ff:ff:ff:ff` 可看作是以太网多播地址的特例）。
如果网卡收到一个帧，这个帧将被传送给设备驱动程序（如果帧检验和错，网卡将丢弃该帧）。
设备驱动程序将进行另外的帧过滤。首先，帧类型中必须指定要使用的协议（IP、ARP 等等）。

其次，进行多播过滤来检测该主机是否属于多播地址说明的多播组。
设备驱动程序随后将数据帧传送给下一层，比如，当帧类型指定为 IP 数据报时，就传往 IP 层。
IP 根据 IP 地址中的源地址和目的地址进行更多的过滤检测。如果正常，就将数据报传送给下一层（如 TCP 或 UDP）。
每次 UDP 收到由 IP 传送来的数据报，就根据目的端口号，有时还有源端口号进行数据报过滤。
如果当前没有进程使用该目的端口号，就丢弃该数据报并产生一个 ICMP 不可达报文
（TCP 根据它的端口号作相似的过滤）。如果 UDP 数据报存在检验和错，将被丢弃。

> 子网掩码

根据 RFC950 定义，子网掩码是一个 32 位的 2 进制数， 其对应网络地址的所有位都置为 1，对应于主机地址的所有位都置为 0。
这个掩码是一个 32 bit 的值，其中`值为1`的`比特`留给`网络号`和`子网号`，为`0的比特`留给`主机号`

> 受限的广播

受限的广播地址是 255.255.255.255。该地址用于主机配置过程中 IP 数据报的目的地址，
此时，主机可能还不知道它所在网络的网络掩码，甚至连它的 IP 地址也不知道。

> 指向网络的广播

指向网络的广播地址是`主机号为全1的地址`。A 类网络广播地址为 netid.255.255.255，其中 netid 为 A 类网络的网络号。
一个路由器必须转发指向网络的广播，但它也必须有一个不进行转发的选择。

> 指向子网的广播

指向子网的广播地址为`主机号为全1`且有`特定子网号`的地址。作为子网直接广播地址的 IP 地址需要了解子网的掩码。
例如，如果路由器收到发往 128.1.2.255 的数据报，当 B 类网络 128.1 的子网掩码为 255.255.255.0 时，
该地址就是指向子网的广播地址；但如果该子网的掩码为 255.255.254.0，该地址就不是指向子网的广播地址。

> 指向所有子网的广播

指向所有子网的广播也需要了解目的网络的子网掩码，以便与指向网络的广播地址区分开。
指向所有`子网的广播`地址的`子网号`及`主机号为全1`。例如，如果目的子网掩码为
255.255.255.0，那么 IP 地址 128.1.255.255 是一个指向所有子网的广播地址。
然而，如果网络没有划分子网，这就是一个指向网络的广播。

## Links

- [子网划分](https://www.cnblogs.com/linhaifeng/articles/5951486.html)
