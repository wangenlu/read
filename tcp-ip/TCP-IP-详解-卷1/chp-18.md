# TCP 连接的建立与终止

> 关键字：

- 建立连接
- TCP 的半关闭
- TCP 的状态变迁图
- MSL 等待状态
- IN_WAIT_2 状态
- 同时打开
- 同时关闭
- TCP 选项
- TCP 服务器的设计
- 建立连接协议
- 最大报文段长度（MSS）

## 建立连接协议

建立一条 TCP 连接

1. 请求端（通常称为客户）发送一个 SYN 段指明客户打算连接的服务器的端口，以及初
2. 服务器发回包含服务器的初始序号的 SYN 报文段（报文段 2）作为应答。同时，将确认
   序号设置为客户的 ISN 加 1 以对客户的 SYN 报文段进行确认。一个 SYN 将占用一个序号。
3. 客户必须将确认序号设置为服务器的 ISN 加 1 以对服务器的 SYN 报文段进行确认（报文段 3）。

这三个报文段完成连接的建立。这个过程也称为三次握手（three-wayhandshake）。

> 图18-3 连接建立与终止的时间系列

![TCP-IP-18-3.png](./images/TCP-IP-18-3.png)

## 连接终止协议

建立一个连接需要三次握手，而终止一个连接要经过4次握手。这由TCP的半关闭（half-close）造成的。
既然一个TCP连接是全双工（即数据在两个方向上能同时传递），因此每个方向必须单独地进行关闭。
这原则就是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向连接。
当一端收到一个FIN，它必须通知应用层另一端几经终止了那个方向的数据传送。发送FIN通常是应用层进行关闭的结果。

收到一个FIN只意味着在这一方向上没有数据流动。一个TCP连接在收到一个FIN后仍能发送数据。
而这对利用半关闭的应用来说是可能的，尽管在实际应用中只有很少的TCP应用程序这样做。

首先进行关闭的一方（即发送第一个FIN）将执行主动关闭，而另一方（收到这个FIN）
执行被动关闭。通常一方完成主动关闭而另一方完成被动关闭(双方也可都执行主动关闭)。

> 图18-4 连接终止期间报文段的正常交换

![TCP-IP-18-4.png](./images/TCP-IP-18-4.png)

## TCP 的半关闭

TCP提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。

为了使用这个特性，编程接口必须为应用程序提供一种方式来说明“我已经完成了数据
传送，因此发送一个文件结束（FIN）给另一端，但我还想接收另一端发来的数据，直到它给我发来文件结束（FIN）”。

图18-10显示了一个半关闭的典型例子。让左方的客户端开始半关闭，当然也可以由另一端开始。开始的两个报文段和
图18-4是相同的：初始端发出的FIN，接着是另一端对这个FIN的ACK报文段。但后面就和图18-4不同，因为接收半关闭的一方仍能发送数据。
我们只显示一个数据报文段和一个ACK报文段，但可能发送了许多数据报文段（将在第19章讨论数据报文段和确认报文段的交换）。
当收到半关闭的一端在完成它的数据传送后，将发送一个FIN关闭这个方向的连接，这将传送一个文件结束符给发起这个半关闭的应用进程。
当对第二个FIN进行确认后，这个连接便彻底关闭了。

![TCP-IP-18-10.png](./images/TCP-IP-18-10.png)

## TCP 的状态变迁图

> 图18-12 TCP的状态变迁图

![TCP-IP-18-12.png](./images/TCP-IP-18-12.png)

> 图18-13 TCP正常连接建立和终止所对应的状态

![TCP-IP-18-13.png](./images/TCP-IP-18-13.png)

- 2MSL 等待状态

TIMEWAIT状态也称为2MSL等待状态。每个具体TCP实现必须选择一个报文段最大生
存时间MSL（MaximumSegmentLifetime）。它是任何报文段被丢弃前在网络内的最长时间。
我们知道这个时间是有限的，因为TCP报文段以IP数据报在网络内传输，而IP数据报则有限制
其生存时间的TTL字段。

这种2MSL等待的另一个结果是这个TCP连接在2MSL等待期间，定义这个连接的插口
（客户的IP地址和端口号，服务器的IP地址和端口号）不能再被使用。这个连接只能在2MSL
结束后才能再被使用。

在连接处于2MSL等待时，任何迟到的报文段将被丢弃。因为处于2MSL等待的、由该插
口对(socketpair)定义的连接在这段时间内不能被再用，因此当要建立一个有效的连接时，来
自该连接的一个较早替身（incarnation）的迟到报文段作为新连接的一部分不可能不被曲解
（一个连接由一个插口对来定义。一个连接的新的实例（instance）称为该连接的替身）。

- FIN_WAIT_2 状态

在FINWAIT2状态我们已经发出了FIN，并且另一端也已对它进行确认。除非我们在实
行半关闭，否则将等待另一端的应用层意识到它已收到一个文件结束符说明，并向我们发一
个FIN来关闭另一方向的连接。只有当另一端的进程完成这个关闭，我们这端才会从
FINWAIT2状态进入TIMEWAIT状态。
这意味着我们这端可能永远保持这个状态。另一端也将处于CLOSEWAIT状态，并一直
保持这个状态直到应用层决定进行关闭。

## 同时打开

两个应用程序同时彼此执行主动打开的情况是可能的，尽管发生的可能性极小。每一方
必须发送一个SYN，且这些SYN必须传递给对方。这需要每一方使用一个对方熟知的端口作
为本地端口。这又称为同时打开（simultaneousopen）。

## 同时关闭

我们在以前讨论过一方（通常但不总是客户方）发送第一个FIN执行主动关闭。双方都执
行主动关闭也是可能的，TCP协议也允许这样的同时关闭（simultaneousclose）。

## TCP 选项

![TCP-IP-18-20.png](./images/TCP-IP-18-20.png)

TCP选项：
```log
<mss512,nop,wscale0,nop,nop,timestamp1466470>
```
MSS选项设置为512，后面是NOP，接着是窗口扩大选项。第一个NOP用来将窗口扩大选项填
充为4字节的边界。同样，10字节的时间戳选项放在两个NOP后，占12字节，同时使两个4字
节的时间戳满足4字节边界。


## TCP 服务器的设计

## 最大报文段长度（MSS）

最大报文段长度（MSS）表示TCP传往另一端的最大块数据的长度。当一个连接建立时，
连接的双方都要通告各自的MSS。我们已经见过MSS都是1024。这导致IP数据报通常是40字
节长：20字节的TCP首部和20字节的IP首部。
在有些书中，将它看作可“协商”选项。它并不是任何条件下都可协商。当建立一个连
接时，每一方都有用于通告它期望接收的MSS选项（MSS选项只能出现在SYN报文段中）。如
果一方不接收来自另一方的MSS值，则MSS就定为默认值536字节（这个默认值允许20字节的
IP首部和20字节的TCP首部以适合576字节IP数据报)。
