# TCP 的坚持定时器

我们已经看到 TCP 通过让接收方指明希望从发送方接收的数据字节数（即窗口大小）来
进行流量控制。如果窗口大小为 0 会发生什么情况呢？这将有效地阻止发送方传送数据，直到
窗口变为非 0 为止。

- TCP 不对 ACK 报文段进行确认，TCP 只确认那些包含有数据的 ACK 报文段。
- 糊涂窗口综合症 Silly Window Syndrome
- 发送方的坚持定时器 persist timer

如果一个确认丢失了，则双方就有可能因为等待对方而使连接终止：接收方等待接收数
据（因为它已经向发送方通告了一个非 0 的窗口），而发送方在等待允许它继续发送数据的窗
口更新。为防止这种死锁情况的发生，发送方使用一个坚持定时器(persist timer)来周期性地
向接收方查询，以便发现窗口是否已增大。这些从发送方发出的报文段称为窗口探查(window probe)。

## 糊涂窗口综合症

基于窗口的流量控制方案，如 TCP 所使用的，会导致一种被称为“糊涂窗口综合症 SWS
Silly Window Syndrome）”的状况。如果发生这种情况，则少量的数据将通过连接进行交换，
而不是满长度的报文段。

该现象可发生在两端中的任何一端：接收方可以通告一个小的窗口（而不是一直等到有
大的窗口时才通告），而发送方也可以发送少量的数据（而不是等待其他的数据以便发送一个
大的报文段）。可以在任何一端采取措施避免出现糊涂窗口综合症的现象。

1)接收方不通告小窗口。通常的算法是接收方不通告一个比当前窗口大的窗口（可以为 0），
除非窗口可以增加一个报文段大小（也就是将要接收的 MSS）或者可以增加接收方缓存空间
的一半，不论实际有多少。

2)发送方避免出现糊涂窗口综合症的措施是只有以下条件之一满足时才发送数据：(a)可
以发送一个满长度的报文段；(b)可以发送至少是接收方通告窗口大小一半的报文段；(c)可以
发送任何数据并且不希望接收 ACK（也就是说，我们没有还未被确认的数据）或者该连接上
不能使用 Nagle 算法。

条件(b)主要对付那些总是通告小窗口（也许比 1 个报文段还小）的主机，条件(c)使我们
在有尚未被确认的数据（正在等待被确认）以及在不能使用 Nagle 算法的情况下，避免发送小
的报文段。如果应用进程在进行小数据的写操作（例如比该报文段还小），条件(c)可以避免出
现糊涂窗口综合症。

这三个条件也可以让我们回答这样一个问题：在有尚未被确认数据的情况下，如果 Nagle
算法阻止我们发送小的报文段，那么多小才算是小呢？从条件(a)中可以看出所谓“小”就是
指字节数小于报文段的大小。条件(b)仅用来对付较老的、原始的主机。

步骤 2 中的条件(b)要求发送方始终监视另一方通告的最大窗口大小，这是一种发送方猜测
对方接收缓存大小的企图。虽然在连接建立时接收缓存的大小可能会减小，但在实际中这种情况很少见。
