# 套接字选项

关键字：

- fcntl
- ioctl

有很多方法来获取和设置影响套接字的选项

- getsockopt 和 setsockopt 函数;
- fcntl 函数;
- ioctl 函数;

fcntl 函数提供了与网络编程相关的如下特性。

非阻塞式 IO。通过使用 F_SETFL 命令设置 O_NONBLOCK 文件状态标志,我们可以把一个
套接字设置为非阻塞型。(参考 16 章)

信号驱动式 I/O，通过使用 F_SETFL 命令设置 O_ASYNC 文件状态标志,我们可以把一个套
接字设置成一旦其状态发生变化,内核就产生一个 SIGIO 信号。(参考 25 章)

F_SETOWN 命令允许我们指定用于接收 SIGIO 和 SIGURG 信号的套接字属主(进程 I 或进
程组 ID)。其中 SIGIO 信号是套接字被设置为信号驱动式 IO 型后产生的(第 25 章),
SIGURG 信号是在新的带外数据到达套接字时产生的(第 24 章)。F_GETOWN 命令返回套接字的当前属主。

```txt
术语“套接宇属主”由 POSIX 定义。历史上源自 Berkeley 的实现称之为“套接字的进程组
ID”,因为存放该 ID 的变量是 socket 结构的 so_pgid 成员(TCPV2 第 438 页)
```

使用 socket 函数新创建的套接字并没有属主。然而如果一个新的套接字是从一个监听套接
字创建来的,那么套接字属主将由已连接套接字从监听套接字继承而来(许多套接字选项也是
这样继承,见 TCPV2 第 462~463 页)。

> 图 7-20 fcntl、ioctl 和路由套接字操作小结

| 操作                           | fcntl               | ioctl                  | 路由套接字 | POSIX      |
| ------------------------------ | ------------------- | ---------------------- | ---------- | ---------- |
| 设置套接字为非阻寒式 IO 型     | F_SETFL, O_NONBLOCK | FIONBIO                |            | fcntl      |
| 设置套接字为信号驱动式 O 型    | F_SETFL, O_ASYNC    | FTOASYNC               |            | fcntl      |
| 设置套接字属主                 | F_SETON             | SIOCSPGRP 或 FTOSETOWI |            | fcntl      |
| 获取套接字属主                 | F_GETOWN            | SIOCGPGRP 或 FIOGETOWN |            | fcntl      |
| 获取套接字接收缓冲区中的字节数 |                     | FIONREAD               |            |            |
| 测试套接字是否处于带外标志     |                     | TSIOCATMARK            |            | sockatmark |
| 获取接口列表                   |                     | SIOCGIFCONF            | sysctl     |            |
| 接口操作                       |                     | SIOC[GS]IFxxx          |            |            |
| ARP 高速缓存操作               |                     | SIOCxxxARP             | RMT_xxx    |            |
| 路由表操作                     |                     | SIOCxxxRT              | RMT_xxx    |            |

## 套接字状态

对于某些套接字选项,针对套接字的状态,什么时候设置或获取选项有时序上的考虑。我们对受影响的选项论及这一点。

下面的套接字选项是由 TCP 已连接套接字从监听套接字`继承`来的(TCP2 第 462~463 页)
SO_DEBUG、 SO_DONTROUTE、 SO_KEEPALIVE、 SO_LINGER、 SO_OOBINLINE、 SO_RCVBUE、
SO_RCVLOWAT、 SO_SNDBUF、SO_SNDLOWAT、 TCP_MAXSEG 和 CP_NODELAY。

这对 TCP 是很重要的,因为 accept 一直要到 TCP 层完成三路握手后才会给服务器返回已连接套接字。
如果想在三路握手完成时确保这些套接字选项中的某一个是给`已连接套接字`设置的,那么我们必须先给`监听套接字`设置该选项。

> 注意：监听套接字的选项设置可以继承

## SO_KEEPLIVE

7.5.5 SO KEEPALIVE 套接字选项
给一个 TCP 套接字设置保持存活( keep-alive)选项后,如果 2 小时内在该套接字的任一方向
上都没有数据交换,TCP 就自动给对端发送一个保持存活探测分节( keep-alive probe)。这是
个对端必须响应的 TCP 分节,它会导致以下三种情况之一。
3,(1)对端以期望的 ACK 响应。应用进程得不到通知(因为一切正常)。在又经过仍无动静的
小时后,TCP 将发出另一个探测分节。
(2)对端以 RST 响应,它告知本端 TCP:对端已崩溃且已重新启动。该套接字的待处理错误
被置为 ECONNRESE,套接字本身则被关闭。
(3)对端对保持存活探测分节没有任何响应。源自 Berkeley 的 TCP 将另外发送 8 个探测分节,
两两相隔 75 秒,试图得到一个响应。TCP 在发出第一个探测分节后 11 分 15 秒内若没有得到任何
响应则放弃。
PLUⅨX 以处理数据的方式来处理保持存活探测分节,即在重传超时之后发送第二个探测
分节,并把超时值加倍,这样一直重传到预配置最大间隔时间为止,而最大间隔时间的默认
值为 10 分钟

如果根本没有对 TCP 的探测分节的响应,该套接字的待处理错误就被置为 ETIMEOU,套接
字本身则被关闭。然而如果该套接字收到一个 ICMP 错误作为某个探测分节的响应,那就返回相
应的错误(图 A-15 和图 A-16),套接字本身也被关闭。这种情形下一个常见的 ICMP 错误是“host
unreachable”(主机不可达),说明对端主机可能并没有崩溃,只是不可达,这种情况下待处理
错误被置为 EHOSTU 八 NREACH。发生这种情况的原因或者是发生网络故障,或者是对端主机已经崩
溃,而最后一跳的路由器也已经检测到它的崩溃。
TCPvI 第 23 章和 TCPV2 第 828~831 页均有对保持存活选项的详细阐述。
对于本选项的一个最常见的问题无疑是时间参数是否可改(通常是想把 2 小时的无活动周期
改为短些的值)。TCPⅤ1 的附录 E 讨论了如何给各种内核修改这些定时参数,不过必须注意大多
数内核是基于整个内核维护这些时间参数的,而不是基于每个套接字维护的,因此如果把无活
动周期从 2 小时改为(譬如说)15 分钟,那将影响到该主机上所有开启了本选项的套接字。然而
这些问题通常是由对本选项功用的误解导致的。
本选项的功用是检测对端主杋是否崩溃或变得不可达(譬如拨号调制解调器连接掉线,电
源发生故障,等等)。如果对端进程崩溃,它的 TCP 将跨连接发送一个 FIN,这可以通过调用
select 很容易地检测到。(这就是我们在 64 节中使用 select 的原因。)同时也要认识到,即使
对任何保持存活探测分节均无响应(第三种情况),我们也不能肯定对端主机已经崩溃,因而
TCP 可能会终止一个有效连接。某个中间路由器崩溃 15 分钟是有可能的,而这段时间正好与主
机的 11 分 15 秒的保持存活探测周期完全重迭。事实上本功能称为“切断”(make-dead)而不是
“保持存活”也许更合适些,因为它可能终止存活的连接。
本选项一般由服务器使用,不过客户也可以使用。服务器使用本选项是因为它们花大部分
时间阻塞在等待穿越 TCP 连接的输入上,也就是说在等待客户的请求。然而如果客户主机连接
掉线、电源掉电或系统崩溃,服务器进程将永远不会知道,并将继续等待永远不会到达的输入
我们称这种情况为半开连接( half-open connection)。保持存活选项将检测出这些半开连接并终
止它们。
有些服务器(特别是 FTP 服务器)提供一个分钟量级的应用层超时。这是由应用进程本身
完成的,一般在读下一个客户命令的 read 调用附近。这个超时与本套接字选项无关。这通常是
清理通向不可达客户的半开连接的较好办法,因为如果应用系统自己实现超时,应用进程就具
备完全的控制能力。
SCTP 有与 TCP 的保持存活机制类似的心搏( heartbeat)机制。心搏机制通过本章稍后讨
论的 SCTP SET*PEER_ADDR* PARAMS 套接字选项的参数而不是本套接字选项控制。对 SCTP
套接字进行本套接字选项的设置将被忽略,它不影响 SCTP 的心搏机制
图 76 对一个 TCP 连接的另一端发生某些事件时我们可以采用的各种检测方法作了汇总。当
我们说“使用 select 判断可读条件”时,其含义为调用 select 来检测套接字是否可读

## SO_LINGER

```c
#include <sys/socket.h>
struct linger {
    int l_onoff; // 0=off, nonzero=on(开关)
    int l_linger; // linger time(延迟时间)
}
```
