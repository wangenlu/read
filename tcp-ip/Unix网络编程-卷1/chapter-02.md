# 传输层:TCP、UDP 和 SCTP

UDP 是一个简单的、不可靠的数据报协议,而 TCP 是一个复杂、可靠的字节流协议。SCTP
与 TCP 类似之处在于它也是一个可靠的传输协议,但它还提供消息边界、传输级别多宿
(multihoming)支持以及将头端阻塞( head-of-line blocking 减少到最小的一种方法。我们必须
了解由这些传输层协议提供给应用进程的服务,这样才能弄清这些协议处理什么,应用进程中又需要处理什么。

TCP 的某些特性一旦理解,就很容易编写健壮的客户和服务器程序,也很容易使用诸如
netstat 等普遍可用的工具来调试客户和服务器程序。本章将阐述以下相关主题:TCP 的三路
握手、TCP 的连接终止序列和 TCP 的 TIME WAIT 状态,SCTP 的四路握手和 SCTP 的连接终止,
加上由套接字层提供的 TCP、UDP 和 SCTP 缓冲机制,等等。

TCP

传输控制协议( Transmission Control Protocol)。TCP 是一个面向连接的协议,
为用户进程提供可靠的全双工字节流。TCP 套接字是一种流套接字( stream socket)。
TCP 关心确认、超时和重传之类的细节。大多数因特网应用程序使用
TCP。注意,TCP 既可以使用 IPV4,也可以使用 IPV6。

UDP

用户数据报协议( User Datagram Protocol)。UDP 是一个无连接协议。UDP 套接
字是一种数据报套接字( datagram socket)。UDP 数据报不能保证最终到达它们
的目的地。与 TCP 一样,UDP 既可以使用 IPv4,也可以使用 IPv6

UDP 是一个简单的传输层协议,在 RFC768[ Postel1980]中有详细说明。应用进程往一个
UDP 套接字写入一个消息,该消息随后被封装( encapsulating)到一个 UDP 数据报,该 UDP 数据
报进而又被封装到一个 IP 数据报,然后发送到目的地。UDP 不保证 UDP 数据报会到达其最终目
的地,不保证各个数据报的先后顺序跨网络后保持不变,也不保证每个数据报只到达一次。
我们使用 UDP 进行网络编程所遇到的问题是它缺乏可靠性。如果一个数据报到达了其最终
目的地,但是校验和检测发现有错误,或者该数据报在网络传输途中被丢弃了,它就无法被投
递给 UDP 套接字,也不会被源端自动重传。如果想要确保一个数据报到达其目的地,可以往应
用程序中添置一大堆的特性:来自对端的确认、本端的超时与重传等
每个 UDP 数据报都有一个长度。如果一个数据报正确地到达其目的地,那么该数据报的长
度将随数据一道传递给接收端应用进程。我们已经提到过 TCP 是一个字节流(byte-stream)协议,
没有任何记录边界(见 12 节),这一点不同于 UDP。

我们也说 UDP 提供无连接的( connectionless)服务,因为 UDP 客户与服务器之间不必存在
任何长期的关系。举例来说,一个 UDP 客户可以创建一个套接字并发送一个数据报给一个给定
的服务器,然后立即用同一个套接字发送另一个数据报给另一个服务器。同样地,一个 UDP 服
务器可以用同一个 UDP 套接字从若干个不同的客户接收数据报,每个客户一个数据报。

TCP 客户先与某个给定服务器建立一个连接,再跨该连接与那个服务器交换数据,然后终止这个连接。
其次,TCP 还提供了可靠性( reliability)。当 TCP 向另一端发送数据时,它要求对端返回
个确认。如果没有收到确认,TCP 就自动重传数据并等待更长时间。在数次重传失败后,TCP
才放弃,如此在尝试发送数据上所花的总时间一般为 4~10 分钟(依赖于具体实现)。

TCP 含有用于动态估算客户和服务器之间的往返时间( round-trip time,RTT)的算法,以
便它知道等待一个确认需要多少时间。举例来说,RTT 在一个局域网上大约是几亳秒,跨越一
个广域网则可能是数秒钟。另外,因为 RTT 受网络流通各种变化因素影响,TCP 还持续估算
个给定连接的 RTT。
TCP 通过给其中每个字节关联一个序列号对所发送的数据进行排序( sequencing)。举例来
说,假设一个应用写 2048 字节到一个 TCP 套接字,导致 TCP 发送 2 个分节:第一个分节所含数据
的序列号为 1~1024,第二个分节所含数据的序列号为 1025~2048。(分节是 TCP 传递给 IP 的数
据单元。)如果这些分节非顺序到达,接收端 TCP 将先根据它们的序列号重新排序,再把结果数
据传递给接收应用。如果接收端 TCP 接收到来自对端的重复数据(譬如说对端认为一个分节己
丢失并因此重传,而这个分节并没有真正丢失,只是网络通信过于拥挤),它可以(根据序列号)
判定数据是重复的,从而丢弃重复数据。

再次,TCP 提供流量控制( flow control)。TCP 总是告知对端在任何时刻它一次能够从对端
接收多少字节的数据,这称为通告窗口( advertised window)。在任何时刻,该窗口指出接收缓
冲区中当前可用的空间量,从而确保发送端发送的数据不会使接收缓冲区溢出。该窗口时刻动
态变化:当接收到来自发送端的数据时,窗口大小就减小,但是当接收端应用从缓冲区中读取
数据时,窗口大小就增大。通告窗口大小减小到 0 是有可能的:当 TCP 对应某个套接字的接收缓
冲区已满,导致它必须等待应用从该缓冲区读取数据时,方能从对端再接收数据。
